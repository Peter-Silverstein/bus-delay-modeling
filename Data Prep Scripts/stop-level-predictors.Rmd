---
title: "sea-gtfs-proj-data-cleaning"
author: "Peter Silverstein"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
# Loading Libraries

# General Use
library(tidyverse)
library(ggplot2)
library(here)
library(keyring)
library(furrr)

# PostgreSQL
library(DBI)
library(RPostgres)

# GIS and Mapping
library(sf)
library(lwgeom) 

# Census
library(tidycensus)
```

# Main Dataset

## Importing Data From SQL

```{r}
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "sea-gtfs-data",
                 host = "localhost",
                 port = 5432,
                 user = "postgres",
                 password = "Parkour")

gtfs_realtime <- dbReadTable(con, "sea_gtfs_data")
gtfs_realtime <- tibble(gtfs_realtime)
```

## Cleaning Data/Verifying Types/Removing Duplicates

```{r}
# NEED TO FIGURE OUT TIMES OVER 24H!
gtfs_main <- gtfs_realtime %>%
  filter(projection == FALSE) %>%
  distinct(trip_id, stop_id, arrival_datetime, .keep_all = TRUE) %>%
  select(trip_id, route_id, stop_id, arrival_datetime, departure_datetime, pull_datetime) %>%
  mutate(trip_id = as.factor(trip_id),
         route_id = as.factor(route_id),
         stop_id = as.factor(stop_id)) %>%
  mutate(arrival_datetime = with_tz(arrival_datetime, "America/Los_Angeles"),
         departure_datetime = with_tz(departure_datetime, "America/Los_Angeles"),
         pull_datetime = with_tz(pull_datetime, "America/Los_Angeles"))

print(paste("Number of rows reduced from", nrow(gtfs_realtime), "to", nrow(gtfs_main)))
```

# Stop Times Dataset

## Importing Stop Times

```{r}
stop_times <- read_csv("Predictor Data Sets/gtfs-static-files/stop_times.txt") %>%
  select(trip_id, arrival_time, departure_time, stop_id, stop_sequence, shape_dist_traveled) %>%
  mutate(trip_id = as.factor(trip_id),
         stop_id = as.factor(stop_id)) %>%
  rename(sched_arrival_time = arrival_time,
         sched_departure_time = departure_time) %>%
  distinct(trip_id, stop_id, .keep_all = TRUE)
```

## Joining to Main Dataset

```{r}
gtfs_main_withstoptimes <- gtfs_main %>%
  left_join(stop_times, by = c("trip_id" = "trip_id",
                              "stop_id" = "stop_id"))
```

## Calculating Delay

```{r}
gtfs_main_withdelays <- gtfs_main_withstoptimes %>%
  mutate(actual_arrival_time = hms::as_hms(format(with_tz(arrival_datetime, "America/Los_Angeles"), "%H:%M:%S")),
         actual_departure_time = hms::as_hms(format(with_tz(departure_datetime, "America/Los_Angeles"), "%H:%M:%S")),
         date = as.POSIXct(format(with_tz(arrival_datetime, "America/Los_Angeles"), "%Y-%m-%d"))) %>%
  mutate(arrival_delay = as.numeric(actual_arrival_time - sched_arrival_time)) %>%
  select(date, 
         trip_id, 
         route_id, 
         stop_id, 
         sched_arrival_time, 
         sched_departure_time,
         actual_arrival_time,
         actual_departure_time,
         arrival_delay,
         stop_sequence,
         shape_dist_traveled,
         pull_datetime)
```

## Checking if Join worked, whether all rows have values for all fields

```{r}
test_df <- gtfs_main_withdelays %>%
  filter(is.na(date))

test_df

# Notes
  # 7626 rows have no date/arrival time
    # could this mean a skipped trip?
    # could not discern a pattern to the missing data, but I note that this pattern would appear in cases when stops were skipped or routes were cancelled
  # 3915 rows have no route_id
    # could probably look up route_id based on trip_id
  # Stop ID 1746 has no stop_times join
    # I cannot discern why this is, exactly, but it's a very small portion of the sample
```

# Traffic by Time Bin

## Loading the dataset

```{r}
congestion_temporal <- read_csv("Predictor Data Sets/Traffic_Count_Studies_by_Hour_Bins-2.csv")
```

## Table w/ average traffic volume by day/hour

```{r}
congestion_dayhour <- congestion_temporal %>%
  mutate(datetime = as.POSIXct(ADD_DTTM, 
                               format = "%m/%d/%Y %I:%M:%S %p", 
                               tz = "America/Los_Angeles")) %>%
  filter(datetime > as.POSIXct("01-01-2015 00:00:00", 
                               format = "%m-%d-%Y %H:%M:%S",
                               tz = "America/Los_Angeles")) %>%
  group_by(WEEKDAY) %>%
  summarize(HR01 = mean(HR01_TOTAL),
            HR02 = mean(HR02_TOTAL),
            HR03 = mean(HR03_TOTAL),
            HR04 = mean(HR04_TOTAL),
            HR05 = mean(HR05_TOTAL),
            HR06 = mean(HR06_TOTAL),
            HR07 = mean(HR07_TOTAL),
            HR08 = mean(HR08_TOTAL),
            HR09 = mean(HR09_TOTAL),
            HR10 = mean(HR10_TOTAL),
            HR11 = mean(HR11_TOTAL),
            HR12 = mean(HR12_TOTAL),
            HR13 = mean(HR13_TOTAL),
            HR14 = mean(HR14_TOTAL),
            HR15 = mean(HR15_TOTAL),
            HR16 = mean(HR16_TOTAL),
            HR17 = mean(HR17_TOTAL),
            HR18 = mean(HR18_TOTAL),
            HR19 = mean(HR19_TOTAL),
            HR20 = mean(HR20_TOTAL),
            HR21 = mean(HR21_TOTAL),
            HR22 = mean(HR22_TOTAL),
            HR23 = mean(HR23_TOTAL),
            HR24 = mean(HR24_TOTAL)) %>%
  mutate(WEEKDAY_NAME = case_when(
    WEEKDAY == 1 ~ "Monday",
    WEEKDAY == 2 ~ "Tuesday",
    WEEKDAY == 3 ~ "Wednesday",
    WEEKDAY == 4 ~ "Thursday",
    WEEKDAY == 5 ~ "Friday",
    WEEKDAY == 6 ~ "Saturday",
    WEEKDAY == 7 ~ "Sunday")) %>%
  mutate(AVG_VOL = select(., HR01:HR24) %>% rowMeans(na.rm = TRUE)) %>%
  relocate(WEEKDAY_NAME, .after = WEEKDAY) %>%
  relocate(AVG_VOL, .after = WEEKDAY_NAME)

congestion_dh_longer <- congestion_dayhour %>%
  select(WEEKDAY_NAME, HR01:HR24) %>%
  pivot_longer(cols = -WEEKDAY_NAME,
               names_to = "HOUR",
               values_to = "avg_traffic_dayhour") %>%
  mutate(HOUR = as.numeric(gsub("[^0-9]","", HOUR)))
```

## Joining Day/Daypart Congestion

```{r}
# MAKE SURE TO REMOVE -1 VALUES
gtfs_main_withcongestion <- gtfs_main_withdelays %>%
  mutate(WEEKDAY = weekdays(date),
         HR = as.numeric(sched_arrival_time) %/% 3600) %>%
  left_join(select(.data = congestion_dayhour, WEEKDAY_NAME, AVG_VOL), 
            by = c("WEEKDAY" = "WEEKDAY_NAME")) %>%
  left_join(congestion_dh_longer,
            by = c("WEEKDAY" = "WEEKDAY_NAME",
                   "HR" = "HOUR")) %>%
    rename("weekday" = "WEEKDAY",
         "hr" = "HR",
         "avg_traffic_day" = "AVG_VOL")
```

# Assorted Visualizations

## Traffic Volume by Day/Time

```{r}
# Ridgeline Plot of Traffic by Day
# Seems that I may want to log it
library(ggridges)

congestion_temporal_ridgeline <- congestion_temporal %>%
  mutate(WEEKDAY_NAME = as.factor(case_when(
    WEEKDAY == 1 ~ "Monday",
    WEEKDAY == 2 ~ "Tuesday",
    WEEKDAY == 3 ~ "Wednesday",
    WEEKDAY == 4 ~ "Thursday",
    WEEKDAY == 5 ~ "Friday",
    WEEKDAY == 6 ~ "Saturday",
    WEEKDAY == 7 ~ "Sunday"))) %>%
  filter(TOTAL != -1,
         TOTAL != 0)

ridgeline_trafficday <- ggplot(data = congestion_temporal_ridgeline,
                               aes(x = log(TOTAL),
                                   y = WEEKDAY_NAME)) + 
  geom_density_ridges(scale = 4) +
  scale_y_discrete(expand = c(0, 0)) + 
  scale_x_continuous(expand = c(0, 0)) + 
  coord_cartesian(clip = "off") + 
  theme_ridges()

ridgeline_trafficday
```

```{r}
# Plot of Average Congestion by Hour by Day
plot_congestion_hourday <- ggplot(data = congestion_dh_longer,
                                  aes(x = HOUR,
                                      y = avg_traffic_dayhour,
                                      color = WEEKDAY_NAME,
                                      linetype = WEEKDAY_NAME)) +
  geom_line()

plot_congestion_hourday
```

## Delay Plots

```{r}
# Delay by Day
library(ggridges)

delay_day_ridgeline <- gtfs_main_withcongestion %>%
  filter(arrival_delay > -2500)

ridgeline_delayday <- ggplot(data = delay_day_ridgeline,
                               aes(x = arrival_delay,
                                   y = weekday)) + 
  geom_density_ridges(scale = 4) +
  scale_y_discrete(expand = c(0, 0)) + 
  scale_x_continuous(expand = c(0, 0)) + 
  coord_cartesian(clip = "off") + 
  theme_ridges()

ridgeline_delayday
```

```{r}
# Scatterplot of avg congestion by avg delay
delay_traffic_data <- gtfs_main_withcongestion %>%
  filter(arrival_delay > -2500) %>%
  mutate(dayhour_traffic_bins = cut(avg_traffic_dayhour, 
                                    breaks = c(-Inf, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, Inf),
                                    labels = c("0-50", "50-100", "100-150", "150-200", "200-250", "250-300", "300-350",
                                               "350-400", "400-450", "450-500", "500-550", "550-600", "600+")))

scatter_delaytraffic <- ggplot(data = delay_traffic_data,
                               aes(x = dayhour_traffic_bins,
                                   y = arrival_delay,
                                   color = dayhour_traffic_bins)) +
  geom_jitter() + 
  theme(legend.position = "none")
scatter_delaytraffic
```

```{r}
# Scatterplot of avg congestion by avg delay
delay_traffic_data <- gtfs_main_withcongestion %>%
  filter(arrival_delay > -2500) %>%
  mutate(dayhour_traffic_bins = cut(avg_traffic_dayhour, 
                                    breaks = c(-Inf, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, Inf),
                                    labels = c("0-50", "50-100", "100-150", "150-200", "200-250", "250-300", "300-350",
                                               "350-400", "400-450", "450-500", "500-550", "550-600", "600+")))

scatter_delaytraffic <- ggplot(data = delay_traffic_data,
                               aes(x = arrival_delay,
                                   y = dayhour_traffic_bins,
                                   fill = dayhour_traffic_bins)) +
  geom_density_ridges() + 
  theme(legend.position = "none") +
  xlim(-500, 500)
scatter_delaytraffic
```

```{r}
# Delay by Day/Hour
day_hour_delay <- gtfs_main_withcongestion %>%
  filter(arrival_delay > 0,
         arrival_delay < 300) %>%
  select(hr, arrival_delay, weekday) %>%
  group_by(weekday, hr) %>%
  summarize(arrival_delay = mean(arrival_delay)) %>%
  ungroup()

plot_delay_hourday <- ggplot(data = day_hour_delay,
                                  aes(x = hr,
                                      y = arrival_delay,
                                      color = weekday,
                                      linetype = weekday)) +
  geom_line()

plot_delay_hourday
```

```{r}
# Delay for route_id = 100001 over time
route_100001_delay <- gtfs_main_withcongestion %>%
  filter(route_id == "100001") %>%
  select(arrival_delay, stop_sequence) %>%
  group_by(stop_sequence) %>%
  summarize(arrival_delay = mean(arrival_delay)) %>%
  ungroup()

plot_delay_100001 <- ggplot(data = route_100001_delay,
                                  aes(x = stop_sequence,
                                      y = arrival_delay)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) + geom_line()

plot_delay_100001
```









































